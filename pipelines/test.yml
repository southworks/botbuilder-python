pool:
  vmImage: 'windows-2019'

variables:
  AppId: $(SlackTestBotAppId)
  AppSecret: $(SlackTestBotAppSecret)
  BotGroup: $(SlackTestBotBotGroup)
  BotName: $(SlackTestBotBotName)
  BuildConfiguration: 'debug'
  BuildPlatform: 'any cpu'
  SlackBotToken: $(SlackTestBotSlackBotToken)
  SlackClientSigningSecret: $(SlackTestBotSlackClientSigningSecret)
  SlackVerificationToken: $(SlackTestBotSlackVerificationToken)
#  AzureSubscription: define this in Azure
#  SlackTestBotAppId: define this in Azure
#  SlackTestBotAppSecret: define this in Azure
#  SlackTestBotBotGroup: define this in Azure
#  SlackTestBotBotName: define this in Azure
#  SlackTestBotSlackBotToken: define this in Azure
#  SlackTestBotSlackChannel: define this in Azure
#  SlackTestBotSlackClientSigningSecret: define this in Azure
#  SlackTestBotSlackVerificationToken: define this in Azure

steps:
- powershell: 'gci env:* | sort-object name | Format-Table -AutoSize -Wrap'
  displayName: 'Display env vars'

- task: AzureCLI@1
  displayName: 'Delete Resources'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptLocation: inlineScript
    inlineScript: 'call az group delete -n "$(BotGroup)" --yes'
  condition: and(always(), ne(variables['DeleteResourceGroup'], 'false'))

- powershell: |
    7z a -tzip "$(System.DefaultWorkingDirectory)/libraries/functional-tests/slackbot/bot.zip"  "$(System.DefaultWorkingDirectory)/libraries/functional-tests/slackbot/*" -aoa
  displayName: 'Zip Bot'

- task: AzureCLI@2
  displayName: 'create Azure resources - new RG template'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      Set-PSDebug -Trace 1;
      # set up resource group, bot channels registration, app service, app service plan
      az deployment sub create --name "$(BotName)" --template-file "$(System.DefaultWorkingDirectory)/libraries/functional-tests/slackbot/deploymentTemplates/template-with-new-rg.json" --location "westus" --parameters groupName="$(BotGroup)" appId="$(AppId)" appSecret="$(AppSecret)" botId="$(BotName)" botSku="F0" newAppServicePlanName="$(BotName)" newWebAppName="$(BotName)" slackVerificationToken="$(SlackVerificationToken)" slackBotToken="$(SlackBotToken)" slackClientSigningSecret="$(SlackClientSigningSecret)" groupLocation="westus" newAppServicePlanLocation="westus";
      Set-PSDebug -Trace 0;

- task: AzureCLI@1
  displayName: 'Deploy bot'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az webapp deployment source config-zip --resource-group "$(BotGroup)" --name "$(BotName)" --src "$(System.DefaultWorkingDirectory)/libraries/functional-tests/slackbot/bot.zip" --timeout 600000

# - script: |
#     git config --global user.name "GitPythonDeploymentUser"
#     git config --global user.email GitPythonDeploymentUser@Pipeline.com
#     git init
#     git add .
#     git commit -m "cibuildtest"
#     git remote add azure https://$(AzureDeploymentUser):$(AzureDeploymentPassword)@$(BotName).scm.azurewebsites.net:443/$(BotName).git
#     git push azure master
#   workingDirectory: '$(System.DefaultWorkingDirectory)/libraries/functional-tests/slackbot'
#   displayName: 'Git bot deployment'

# - task: AzureCLI@2
#   displayName: 'Validate git deployment'
#   inputs:
#     azureSubscription: $(AzureSubscription)
#     scriptType: pscore
#     scriptLocation: inlineScript
#     inlineScript: |
#       #Getting logs from Azure
#       az webapp log download --name $(BotName) --resource-group $(BotGroup) --log-file "$(System.DefaultWorkingDirectory)\logs.zip";
#       Expand-Archive "$(System.DefaultWorkingDirectory)\logs.zip" -DestinationPath "$(System.DefaultWorkingDirectory)\logs";
#       $file = "$(System.DefaultWorkingDirectory)/logs/deployments/*/log.log"
#       $content = Get-Content $file

#       #Validates if the log contains the Deployment successful line
#       Write-Host "Validating deployment log."
#       $containsWord = $content | %{$_ -match "Deployment successful"}
#       if ($containsWord -contains $true) {
#           Write-Host "Deployment successful, check the git deploy step for more information."
#       } else {
#           Write-Host "An error occurred during the deploy."
#           Write-Output $content
#           Write-Error "An error occurred during the deploy."
#       }
#   condition: succeededOrFailed()

# - script: |
#     python -m pip install --upgrade pip
#     pip install -e ./libraries/functional-tests/tests/requirements.txt
#     pip install pytest
#   displayName: 'Install dependencies'

# - script: |
#     pytest
#   displayName: Pytest

# - task: AzureCLI@1
#   displayName: 'Delete Resources'
#   inputs:
#     azureSubscription: $(AzureSubscription)
#     scriptLocation: inlineScript
#     inlineScript: 'call az group delete -n "$(BotGroup)" --yes'
#   condition: and(always(), ne(variables['DeleteResourceGroup'], 'false'))
